<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>instruction_book_finance_class_shiny</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="instruction_book_finance_shiny_files/libs/clipboard/clipboard.min.js"></script>
<script src="instruction_book_finance_shiny_files/libs/quarto-html/quarto.js"></script>
<script src="instruction_book_finance_shiny_files/libs/quarto-html/popper.min.js"></script>
<script src="instruction_book_finance_shiny_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="instruction_book_finance_shiny_files/libs/quarto-html/anchor.min.js"></script>
<link href="instruction_book_finance_shiny_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="instruction_book_finance_shiny_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="instruction_book_finance_shiny_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="instruction_book_finance_shiny_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="instruction_book_finance_shiny_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">instruction_book_finance_class_shiny</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="instruction-book-for-using-the-shiny-based-portfolio-management-class-in-a-virtual-classroom-setting" class="level2">
<h2 class="anchored" data-anchor-id="instruction-book-for-using-the-shiny-based-portfolio-management-class-in-a-virtual-classroom-setting"><strong>Instruction Book for Using the Shiny-Based “Portfolio Management Class” in a Virtual Classroom Setting</strong></h2>
<section id="table-of-contents" class="level3">
<h3 class="anchored" data-anchor-id="table-of-contents"><strong>Table of Contents</strong></h3>
<ol type="1">
<li><p><strong>Introduction</strong></p></li>
<li><p><strong>What Does This Shiny App Do?</strong></p></li>
<li><p><strong>How to Set Up and Run the Shiny App</strong></p>
<ul>
<li><p>Prerequisites</p></li>
<li><p>Running the App</p></li>
</ul></li>
<li><p><strong>Using the Shiny App in a Virtual Class</strong></p>
<ul>
<li><p>Zoom Setup and Integration</p></li>
<li><p>Step-by-Step Guide to Running the Class</p></li>
</ul></li>
<li><p><strong>Detailed Breakdown of the Shiny App</strong></p>
<ul>
<li><p>Portfolio Management Overview</p></li>
<li><p>Key Features of the App</p></li>
</ul></li>
<li><p><strong>Portfolio Summary Features</strong></p>
<ul>
<li><p>Net Portfolio Value</p></li>
<li><p>Cash Available</p></li>
<li><p>Borrowed Cash (at 10% Annual Interest)</p></li>
<li><p>Total and Weekly Portfolio Increases</p></li>
</ul></li>
<li><p><strong>Additional Features</strong></p>
<ul>
<li><p>Event Influences</p></li>
<li><p>Securities Price History</p></li>
</ul></li>
<li><p><strong>FAQ</strong></p></li>
<li><p><strong>Troubleshooting</strong></p></li>
</ol>
</section>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction"><strong>1. Introduction</strong></h3>
<p>This instruction book will guide you through the <strong>“Portfolio Management Class” Shiny app</strong>, designed for teaching students about managing an investment portfolio in a simulated, event-driven market environment. This app is especially suited for virtual classroom settings using platforms like Zoom.</p>
<p>The app simulates securities price movements over a year, and participants will make weekly investment decisions, buying and selling securities while managing their cash, borrowing funds, and paying interest.</p>
</section>
<section id="what-does-this-shiny-app-do" class="level3">
<h3 class="anchored" data-anchor-id="what-does-this-shiny-app-do"><strong>2. What Does This Shiny App Do?</strong></h3>
<p>The <strong>Portfolio Management Class</strong> app helps students simulate managing a portfolio of 5 securities by investing virtual cash. The app includes:</p>
<ul>
<li><p>A <strong>price history</strong> for the securities, which can fluctuate based on a random log-normal distribution.</p></li>
<li><p><strong>Event influences</strong> that can affect the price of the securities.</p></li>
<li><p><strong>Portfolio Summary</strong> with real-time updates on portfolio value, cash available, borrowed funds, and interest charges.</p></li>
<li><p><strong>Total and weekly increase</strong> in portfolio value for each round.</p></li>
<li><p><strong>Borrowing mechanism</strong>: Students can borrow funds if they run out of cash, and they must pay interest on the borrowed cash at 10% annually (calculated per week).</p></li>
</ul>
</section>
<section id="how-to-set-up-and-run-the-shiny-app" class="level3">
<h3 class="anchored" data-anchor-id="how-to-set-up-and-run-the-shiny-app"><strong>3. How to Set Up and Run the Shiny App</strong></h3>
<section id="prerequisites" class="level4">
<h4 class="anchored" data-anchor-id="prerequisites"><strong>Prerequisites</strong></h4>
<p>Before running the Shiny app, ensure you have the following:</p>
<ul>
<li><p><strong>R</strong> installed on your computer. You can download it from CRAN.</p></li>
<li><p><strong>RStudio</strong> (optional but recommended for ease of use).</p></li>
<li><p>Necessary R packages, including <code>shiny</code> and <code>ggplot2</code>, installed. You can install these packages by running the following command in R:</p></li>
</ul>
<pre><code>r</code></pre>
<p>Copy code</p>
<p><code>install.packages(c("shiny", "ggplot2"))</code></p>
</section>
<section id="running-the-app" class="level4">
<h4 class="anchored" data-anchor-id="running-the-app"><strong>Running the App</strong></h4>
<p>Once you have R and RStudio installed, follow these steps:</p>
<ol type="1">
<li><p><strong>Copy the Shiny App Code</strong>: Copy the complete Shiny code provided earlier into an R script (e.g., <code>portfolio_management_class.R</code>).</p></li>
<li><p><strong>Run the App</strong>:</p>
<ul>
<li><p>Open the script in RStudio.</p></li>
<li><p>Click the <strong>Run App</strong> button or type the following command in the R console:</p></li>
</ul></li>
</ol>
<pre><code>r</code></pre>
<p>Copy code</p>
<p><code>shiny::runApp('path_to_your_script')</code></p>
<p>The app will launch in your default web browser, and you can start using it for your class.</p>
</section>
</section>
<section id="using-the-shiny-app-in-a-virtual-class" class="level3">
<h3 class="anchored" data-anchor-id="using-the-shiny-app-in-a-virtual-class"><strong>4. Using the Shiny App in a Virtual Class</strong></h3>
<section id="zoom-setup-and-integration" class="level4">
<h4 class="anchored" data-anchor-id="zoom-setup-and-integration"><strong>Zoom Setup and Integration</strong></h4>
<ol type="1">
<li><p><strong>Host a Zoom Session</strong>: Schedule and host a Zoom session for your class.</p></li>
<li><p><strong>Share Your Screen</strong>: Open the Shiny app in your web browser and share your screen with the participants using Zoom’s “Share Screen” feature.</p></li>
<li><p><strong>Interactive Experience</strong>:</p>
<ul>
<li>You can allow participants to control the app by giving them access to remote control through Zoom, or you can guide them through each investment decision step while they make notes of their decisions offline.</li>
</ul></li>
<li><p><strong>Breakout Rooms (Optional)</strong>:</p>
<ul>
<li>You may use Zoom’s breakout room feature to split participants into smaller groups to discuss strategies, then return to the main session for decision submissions.</li>
</ul></li>
</ol>
</section>
<section id="step-by-step-guide-to-running-the-class" class="level4">
<h4 class="anchored" data-anchor-id="step-by-step-guide-to-running-the-class"><strong>Step-by-Step Guide to Running the Class</strong></h4>
<ol type="1">
<li><p><strong>Introduction (10-15 minutes)</strong>:</p>
<ul>
<li>Explain the purpose of the simulation and the key concepts: portfolio value, cash management, interest on borrowed cash, and the effect of market events on securities.</li>
</ul></li>
<li><p><strong>Investment Rounds (60-75 minutes)</strong>:</p>
<ul>
<li><p>Run several rounds (6-8) where each round represents one week of investment.</p></li>
<li><p>In each round:</p>
<ol type="1">
<li><p><strong>Review the Event Influences</strong> for the current round.</p></li>
<li><p><strong>Discuss Securities Performance</strong> based on price movements.</p></li>
<li><p><strong>Students Make Investment Decisions</strong>: Adjust holdings of securities using the sliders, within the limit of their available cash or borrowed funds.</p></li>
</ol></li>
</ul></li>
<li><p><strong>Final Reflection (15 minutes)</strong>:</p>
<ul>
<li><p>Analyze the results at the end of the session.</p></li>
<li><p>Discuss strategies that worked, challenges in managing cash and debt, and how events influenced investment decisions.</p></li>
</ul></li>
</ol>
</section>
</section>
<section id="detailed-breakdown-of-the-shiny-app" class="level3">
<h3 class="anchored" data-anchor-id="detailed-breakdown-of-the-shiny-app"><strong>5. Detailed Breakdown of the Shiny App</strong></h3>
<section id="portfolio-management-overview" class="level4">
<h4 class="anchored" data-anchor-id="portfolio-management-overview"><strong>Portfolio Management Overview</strong></h4>
<p>In the Shiny app, students manage an investment portfolio with 5 securities:</p>
<ul>
<li><p><strong>Global Oil</strong>: Petroleum Drilling &amp; Refining</p></li>
<li><p><strong>Tech Giant</strong>: Technology</p></li>
<li><p><strong>Healthcare Innovations</strong>: Pharmaceuticals &amp; Biotech</p></li>
<li><p><strong>Retail Power</strong>: Retail &amp; Consumer Goods</p></li>
<li><p><strong>Green Energy Solutions</strong>: Renewable Energy</p></li>
</ul>
<p>Each round simulates a week in a 1-year timeline. Each round presents new events, and students decide how to adjust their investments.</p>
</section>
<section id="key-features-of-the-app" class="level4">
<h4 class="anchored" data-anchor-id="key-features-of-the-app"><strong>Key Features of the App</strong></h4>
<ul>
<li><p><strong>Zero initial holdings</strong>: At the start, students have $10,000 in cash and no securities.</p></li>
<li><p><strong>Borrowing at 10% interest</strong>: If students need more than $10,000 to buy securities, they borrow the additional funds and are charged weekly interest.</p></li>
<li><p><strong>Real-time portfolio updates</strong>: As the rounds progress, students can track their portfolio value, borrowed funds, and cash available.</p></li>
</ul>
</section>
</section>
<section id="portfolio-summary-features" class="level3">
<h3 class="anchored" data-anchor-id="portfolio-summary-features"><strong>6. Portfolio Summary Features</strong></h3>
<p>The Portfolio Summary section displays three critical values:</p>
<ol type="1">
<li><p><strong>Net Portfolio Value</strong>: This is the current value of all securities in the student’s portfolio plus the cash available, minus any borrowed cash and weekly interest on borrowed cash.</p></li>
<li><p><strong>Cash Available</strong>: This shows how much cash the student has left to invest.</p></li>
<li><p><strong>Borrowed Cash</strong>: Shows the total amount borrowed, with interest deducted weekly at 10% annually.</p></li>
</ol>
<p>Additionally, there are two more values:</p>
<ul>
<li><p><strong>Total Increase in Portfolio Value</strong>: The cumulative increase in portfolio value over the entire simulation.</p></li>
<li><p><strong>Weekly Increase in Portfolio Value</strong>: The change in portfolio value from the previous week/round.</p></li>
</ul>
</section>
<section id="additional-features" class="level3">
<h3 class="anchored" data-anchor-id="additional-features"><strong>7. Additional Features</strong></h3>
<section id="event-influences" class="level4">
<h4 class="anchored" data-anchor-id="event-influences"><strong>Event Influences</strong></h4>
<p>In each round, new market events are randomly generated that affect the prices of the 5 securities. These events are labeled <strong>Event 1</strong>, <strong>Event 2</strong>, etc., and they change the behavior of the securities in the market. For example, a tech boom will boost Tech Giant, while a market crash might reduce prices across the board.</p>
</section>
<section id="securities-price-history" class="level4">
<h4 class="anchored" data-anchor-id="securities-price-history"><strong>Securities Price History</strong></h4>
<p>Students can view the historical prices of all 5 securities on a line graph. As new rounds progress, additional weeks are appended to the graph to show how prices evolve over time.</p>
</section>
</section>
<section id="faq" class="level3">
<h3 class="anchored" data-anchor-id="faq"><strong>8. FAQ</strong></h3>
<p><strong>Q1. How many rounds should I run in one class session?</strong></p>
<ul>
<li>It is recommended to run between 6 and 8 rounds, which will simulate 6-8 weeks of portfolio management.</li>
</ul>
<p><strong>Q2. What happens if a student runs out of cash?</strong></p>
<ul>
<li>If a student runs out of cash, they can still buy securities by borrowing funds. The borrowed funds are subject to a 10% annual interest rate, charged weekly.</li>
</ul>
<p><strong>Q3. How do events influence the securities?</strong></p>
<ul>
<li>Events are randomly selected each week and may positively or negatively impact one or more securities. The price movements reflect the nature of the event (e.g., oil price surges will boost Global Oil, while a market crash will affect all securities).</li>
</ul>
</section>
<section id="troubleshooting" class="level3">
<h3 class="anchored" data-anchor-id="troubleshooting"><strong>9. Troubleshooting</strong></h3>
<p><strong>Problem: The app doesn’t run.</strong></p>
<ul>
<li>Make sure you have R and RStudio installed, and that the necessary packages (<code>shiny</code>, <code>ggplot2</code>) are installed.</li>
</ul>
<p><strong>Problem: Portfolio Summary doesn’t update.</strong></p>
<ul>
<li>Ensure that the investment sliders have been adjusted and the “Submit Investments” button is clicked after making adjustments.</li>
</ul>
<p><strong>Problem: I can’t see the plot or the event table.</strong></p>
<ul>
<li>Check that your R console is not throwing any errors, and ensure that the app is running in a browser window.</li>
</ul>
<p>This instruction book should now fully guide you on how to use the <strong>Portfolio Management Class</strong> Shiny app in a virtual setting. You can adapt the session based on the number of rounds, the pace of the class, and any additional discussion topics related to investment and financial management.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>